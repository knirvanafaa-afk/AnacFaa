<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulado - Área do Aluno</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 600px; background: white; padding: 30px; border-radius: 20px; box-shadow: 0px 10px 25px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        
        .section-config { border: 2px solid #2ecc71; padding: 20px; border-radius: 15px; background-color: #fafffa; margin-bottom: 20px; }
        
        label { display: block; margin-top: 10px; font-weight: bold; color: #444; }
        select { 
            width: 100%; 
            padding: 12px; 
            margin-top: 5px; 
            border: 2px solid #f1c40f; /* Borda amarela do alerta */
            border-radius: 10px; 
            box-sizing: border-box; 
            font-size: 16px; 
            outline: none; 
            background-color: #fff9c4; /* Fundo amarelo claro do alerta */
            color: #333; /* Cor do texto */
            font-family: 'Segoe UI', sans-serif;
            font-weight: bold; /* Deixa o texto mais visível no fundo amarelo */
            cursor: pointer;
        }

        /* Ajuste para quando o seletor estiver desativado (Capítulo) */
        select:disabled {
            background-color: #eeeeee;
            border-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .btn-iniciar { background-color: #27ae60; color: white; width: 100%; padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; text-transform: uppercase; margin-top: 20px; }
    </style>
</head>
<body>

<div id="custom-alert" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: #fff9c4; border: 3px solid #f1c40f; padding: 25px; border-radius: 20px; max-width: 300px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
        <p id="alert-message" style="color: #333; font-weight: bold; font-size: 18px; margin-bottom: 20px;"></p>
        <button onclick="fecharAlerta()" style="background: #27ae60; color: white; border: none; padding: 10px 30px; border-radius: 10px; cursor: pointer; font-weight: bold; text-transform: uppercase;">OK</button>
    </div>
</div>

<div class="container">
    <h2>PROVA SIMULADA</h2>

    <div class="section-config">
     <label>Selecione a Matéria:</label> <select id="materia_simulado" onchange="window.carregarCapitulos()"> <option value="">-- Selecione --</option> <option value="General">General</option> <option value="Airframe">Airframe</option> <option value="Powerplant">Powerplant</option> </select> <label>Selecione o Capítulo:</label> <select id="capitulo_simulado" disabled> <option value="todos">Todos os Capítulos</option> </select> 
        
        <label>Quantidade de Questões</label>
        <select id="qtd_questoes">
            <option value="10">10 Perguntas</option>
            <option value="20">20 Perguntas</option>
            <option value="30">30 Perguntas</option>
            <option value="50">50 Perguntas</option>
            <option value="100">100 Perguntas</option>
        </select>

        <button class="btn-iniciar" onclick="iniciarProva()">Iniciar Prova</button>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabaseUrl = 'https://ymyxikhlhkkvcufgwufe.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlteXhpa2hsaGtrdmN1Zmd3dWZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MTc4MTYsImV4cCI6MjA4NjQ5MzgxNn0.kcbbkKDx1Jt2ayX2KwJa0Pr8ZsGTj4BTxV1y2RXU9WA'
    const supabase = createClient(supabaseUrl, supabaseKey)

    // 1. BUSCA DINÂMICA DE CAPÍTULOS (Baseada na matéria selecionada)
    window.carregarCapitulos = async () => {
        const mat = document.getElementById('materia_simulado').value;
        const selectCap = document.getElementById('capitulo_simulado');
        
        selectCap.innerHTML = '<option value="todos">Todos os Capítulos</option>';
        
        if (!mat) {
            selectCap.disabled = true;
            return;
        }

        try {
            // Busca capítulos únicos daquela matéria no banco
            const { data, error } = await supabase
                .from('questoes')
                .select('capitulo')
                .eq('materia', mat)
                .not('capitulo', 'is', null);

            if (error) throw error;

            // Remove duplicados e limpa campos vazios
            const capsUnicos = [...new Set(data.map(item => item.capitulo))].filter(c => c && c.trim() !== "");

            capsUnicos.forEach(cap => {
                const opt = document.createElement('option');
                opt.value = cap;
                opt.innerText = cap;
                selectCap.appendChild(opt);
            });

            selectCap.disabled = false;
        } catch (e) {
            console.error("Erro ao carregar capítulos:", e);
        }
    };

    // 2. INICIAR A PROVA (Salvando as configurações na sessão)
    window.iniciarProva = () => {
        const mat = document.getElementById('materia_simulado').value;
        const cap = document.getElementById('capitulo_simulado').value;
        const qtd = document.getElementById('qtd_questoes').value;
        
        if(!mat || mat === "") {
            window.mostrarMensagem("Por favor, selecione uma matéria!");
            return;
        }

        // Guardamos a Matéria, o Capítulo e a Quantidade para a página prova.html usar
        sessionStorage.setItem('config_materia', mat);
        sessionStorage.setItem('config_capitulo', cap); // NOVO: Agora salvamos o capítulo também
        sessionStorage.setItem('config_qtd', qtd);
        
        window.location.href = 'prova.html';
    };

    // 3. ALERTAS PERSONALIZADOS
    window.mostrarMensagem = (texto) => {
        document.getElementById('alert-message').innerText = texto;
        document.getElementById('custom-alert').style.display = 'flex';
    };

    window.fecharAlerta = () => {
        document.getElementById('custom-alert').style.display = 'none';
    };

// Este evento dispara sempre, inclusive quando você volta pelo botão do navegador
window.addEventListener('pageshow', (event) => {
    const materiaSelect = document.getElementById('materia_simulado');
    // Se houver uma matéria selecionada (mesmo vindo do cache), carrega os capítulos
    if (materiaSelect && materiaSelect.value !== "") {
        window.carregarCapitulos();
    }
});

</script>

</body>
</html>

